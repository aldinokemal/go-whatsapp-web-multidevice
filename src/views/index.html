<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.8/semantic.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.4/css/dataTables.semanticui.min.css">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.4/js/dataTables.semanticui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.8/semantic.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios@1.1.2/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <title>Whatsapp API Multi Device {{ .AppVersion }}</title>

    <style>
        .container {
            padding-top: 2em;
        }
    </style>
</head>
<body>
<div class="ui container" id="app">
    <h1 class="ui header center aligned">[[ app_name ]]</h1>

    <div class="ui success message" v-if="connected_devices != null">
        <div class="header">
            Device has connected
        </div>
        <p>
            Device ID: <b>[[ connected_devices[0].device ]]</b>
        </p>
    </div>

    <div class="ui horizontal divider">
        App
    </div>

    <div class="ui three column stackable grid cards">
        <div class="green card" @click="loginModal" style="cursor: pointer">
            <div class="content">
                <div class="header">Login</div>
                <div class="description">
                    Scan your QRCode and you can use all this API feature
                </div>
            </div>
        </div>
        <div class="green card" @click="logoutProcess" style="cursor: pointer">
            <div class="content">
                <div class="header">Logout</div>
                <div class="description">
                    Remove your login session in application
                </div>
            </div>
        </div>
        <div class="green card" @click="reconnectProcess" style="cursor: pointer">
            <div class="content">
                <div class="header">Reconnect</div>
                <div class="description">
                    Reconnect to whatsapp server, please do this if your api doesn't work or your application is down or
                    restart
                </div>
            </div>
        </div>
    </div>

    <div class="ui horizontal divider">
        Send
    </div>

    <div class="ui three column doubling grid cards">
        <send-message></send-message>
        <send-image></send-image>
        <send-file max-file-size="{{ .MaxFileSize }}"></send-file>

        <send-video max-video-size="{{ .MaxVideoSize }}"></send-video>
        <send-contact></send-contact>
        <send-location></send-location>

        <send-audio></send-audio>
        <send-poll></send-poll>
    </div>

    <div class="ui horizontal divider">
        Message
    </div>

    <div class="ui three column doubling grid cards">
        <message-revoke></message-revoke>
        <message-react></message-react>
        <message-update></message-update>
    </div>

    <div class="ui horizontal divider">
        Account
    </div>

    <div class="ui four column doubling grid cards">
        <account-avatar></account-avatar>
        <account-user-info></account-user-info>
        <account-group></account-group>
        <div class="green card" @click="privacyModal" style="cursor: pointer">
            <div class="content">
                <div class="header">My Privacy Setting</div>
                <div class="description">
                    Get your privacy settings
                </div>
            </div>
        </div>
    </div>


    <!--  Modal Login  -->
    <div class="ui small modal" id="modalLogin">
        <i class="close icon"></i>
        <div class="header">
            Login Whatsapp
        </div>
        <div class="image content">
            <div class="ui medium image">
                <img :src="login_link" alt="qrCodeLogin">
            </div>
            <div class="description">
                <div class="ui header">Please scan to connect</div>
                <p>Open Setting > Linked Devices > Link Device</p>
                <div style="padding-top: 50px;">
                    <i>Refresh QR Code in [[ login_duration_sec ]] seconds to avoid link expiration</i>
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui approve positive right labeled icon button" @click="loginApiGetQrCode">
                Refresh QR Code
                <i class="refresh icon"></i>
            </div>
        </div>
    </div>

    <!--  Modal UserPrivacy  -->
    <div class="ui small modal" id="modalUserPrivacy">
        <i class="close icon"></i>
        <div class="header">
            My Privacy
        </div>
        <div class="content">
            <ol v-if="data_privacy != null">
                <li>Who can add Group : <b>[[ data_privacy.group_add ]]</b></li>
                <li>Who can see my Last Seen : <b>[[ data_privacy.last_seen ]]</b></li>
                <li>Who can see my Status : <b>[[ data_privacy.status ]]</b></li>
                <li>Who can see my Profile : <b>[[ data_privacy.profile ]]</b></li>
                <li>Read Receipts : <b>[[ data_privacy.read_receipts ]]</b></li>
            </ol>
        </div>
    </div>

</div>
<script>
    window.TYPEGROUP = "g.us";
    window.TYPEUSER = "s.whatsapp.net";
    window.showErrorInfo = (message) => {
        $('body').toast({
            position: 'bottom right',
            title: 'Error',
            message: message,
            showProgress: 'bottom',
            classProgress: 'red'
        });
    }
    window.showSuccessInfo = (message) => {
        $('body').toast({
            position: 'bottom right',
            title: 'Success',
            message: message,
            showProgress: 'bottom',
            classProgress: 'green'
        });
    }

    window.http = axios.create({
        baseURL: {{ .AppHost }}
    });
    {{ if isEnableBasicAuth .BasicAuthToken }}
    window.http.defaults.headers.common['Authorization'] = {{ .BasicAuthToken }};
    {{ end }}
</script>
<script type="module">
    import SendMessage from "./components/SendMessage.js";
    import SendImage from "./components/SendImage.js";
    import SendFile from "./components/SendFile.js";
    import SendVideo from "./components/SendVideo.js";
    import SendContact from "./components/SendContact.js";
    import SendLocation from "./components/SendLocation.js";
    import SendAudio from "./components/SendAudio.js";
    import SendPoll from "./components/SendPoll.js";
    import MessageUpdate from "./components/MessageUpdate.js";
    import MessageReact from "./components/MessageReact.js";
    import MessageRevoke from "./components/MessageRevoke.js";
    import AccountAvatar from "./components/AccountAvatar.js";
    import AccountUserInfo from "./components/AccountUserInfo.js";
    import AccountGroup from "./components/AccountGroup.js";

    const showErrorInfo = (message) => {
        $('body').toast({
            position: 'bottom right',
            title: 'Error',
            message: message,
            showProgress: 'bottom',
            classProgress: 'red'
        });
    }
    const showSuccessInfo = (message) => {
        $('body').toast({
            position: 'bottom right',
            title: 'Success',
            message: message,
            showProgress: 'bottom',
            classProgress: 'green'
        });
    }

    const login = {
        data() {
            return {
                login_link: '',
                login_duration_sec: 0,
                autoUpdateQRCode: null,
            }
        },
        methods: {
            async loginModal() {
                try {
                    await this.loginApiGetQrCode();
                    $('#modalLogin').modal({
                        onApprove: function () {
                            return false;
                        }
                    }).modal('show');
                } catch (err) {
                    showErrorInfo(err)
                }
            },
            loginApiGetQrCode() {
                return new Promise(async (resolve, reject) => {
                    try {
                        let response = await http.get(`/app/login`)
                        let results = response.data.results;
                        this.login_link = results.qr_link;
                        this.login_duration_sec = results.qr_duration;
                        resolve()
                    } catch (error) {
                        if (error.response) {
                            reject(error.response.data.message)
                        } else {
                            reject(error.message)
                        }
                    }
                })
            }
        }
    }

    const logout = {
        methods: {
            async logoutProcess() {
                try {
                    await this.logoutApi()
                    showSuccessInfo("Logout success")

                    // fetch devices
                    this.app_ws.send(JSON.stringify({"code": "FETCH_DEVICES"}))
                } catch (err) {
                    showErrorInfo(err)
                }
            },

            logoutApi() {
                return new Promise(async (resolve, reject) => {
                    try {
                        await http.get(`/app/logout`)
                        resolve()
                    } catch (error) {
                        if (error.response) {
                            reject(error.response.data.message)
                        } else {
                            reject(error.message)
                        }
                    }
                })
            }
        }
    }

    const reconnect = {
        methods: {
            async reconnectProcess() {
                try {
                    await this.reconnectApi()
                    showSuccessInfo("Reconnect success")
                    // fetch devices
                    this.app_ws.send(JSON.stringify({"code": "FETCH_DEVICES"}))
                } catch (err) {
                    showErrorInfo(err)
                }
            },

            reconnectApi() {
                return new Promise(async (resolve, reject) => {
                    try {
                        await http.get(`/app/reconnect`)
                        resolve()
                    } catch (error) {
                        if (error.response) {
                            reject(error.response.data.message)
                        } else {
                            reject(error.message)
                        }
                    }
                })
            }
        }
    }

    const userPrivacy = {
        data() {
            return {
                data_privacy: null
            }
        },
        methods: {
            async privacyModal() {
                try {
                    await this.privacyApi();
                    $('#modalUserPrivacy').modal('show');
                    showSuccessInfo("Privacy fetched")
                } catch (err) {
                    showErrorInfo(err)
                }
            },
            privacyApi() {
                return new Promise(async (resolve, reject) => {
                    try {
                        let response = await http.get(`/user/my/privacy`)
                        this.data_privacy = response.data.results;
                        resolve()
                    } catch (error) {
                        if (error.response) {
                            reject(error.response.data.message)
                        } else {
                            reject(error.message)
                        }
                    }
                })
            }
        }
    }

    Vue.createApp({
        components: {
            SendMessage, SendImage, SendFile, SendVideo, SendContact, SendLocation, SendAudio, SendPoll,
            MessageUpdate, MessageReact, MessageRevoke,
            AccountAvatar, AccountUserInfo, AccountGroup,
        },
        delimiters: ['[[', ']]'],
        data() {
            return {
                app_ws: null,
                app_host: {{ .AppHost }},
                app_name: 'Whatsapp API Multi Device ({{ .AppVersion }})',
                is_logged_in: false,
                connected_devices: null,
                type_group: "g.us",
                type_user: "s.whatsapp.net"
            }
        },
        mounted() {
            if (window["WebSocket"]) {
                let wsType = location.protocol !== 'https:' ? 'ws://' : 'wss://';
                this.app_ws = new WebSocket(wsType + document.location.host + "/ws");

                this.app_ws.onopen = (evt) => {
                    this.app_ws.send(JSON.stringify({
                        "code": "FETCH_DEVICES",
                        "message": "List device"
                    }))
                };

                this.app_ws.onmessage = (evt) => {
                    const message = JSON.parse(evt.data)
                    switch (message.code) {
                        case 'LOGIN_SUCCESS':
                            showSuccessInfo(message.message)
                            $('#modalLogin').modal('hide');

                            // fetch devices
                            this.app_ws.send(JSON.stringify({"code": "FETCH_DEVICES"}))
                            break;
                        case 'LIST_DEVICES':
                            this.connected_devices = message.result
                            break;
                        default:
                            console.log(message)
                    }
                };
            } else {
                console.error('Your browser does not support WebSockets');
            }
        },
        mixins: [
            login, logout, reconnect,
            userPrivacy
        ]
    }).mount('#app')
</script>
</body>
</html>